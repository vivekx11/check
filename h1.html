

<!--
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Game - Modern UI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #6A1B9A, #AB47BC);
      --secondary-gradient: linear-gradient(135deg, #4A148C, #7B1FA2);
      --bg-gradient: radial-gradient(circle at top left, #4A148C, #7B1FA2, #AB47BC);
      --card-bg: rgba(255, 255, 255, 0.1);
      --card-border: rgba(255, 255, 255, 0.2);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      --border-radius: 20px;
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-gradient);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      margin-bottom: 20px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      padding: 12px;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .logo:hover {
      transform: scale(1.05);
    }

    .logo i {
      font-size: 24px;
      color: var(--text-primary);
    }

    .title {
      font-size: 2rem;
      font-weight: 800;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .subtitle {
      font-size: 1rem;
      color: var(--text-secondary);
      font-weight: 400;
    }

    .profile-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid var(--card-border);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      backdrop-filter: blur(10px);
    }

    .profile-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .profile-btn i {
      font-size: 20px;
      color: var(--text-primary);
    }

    .logout-btn {
      background: rgba(255, 0, 0, 0.2);
      border: 1px solid rgba(255, 0, 0, 0.3);
      color: var(--text-primary);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: var(--transition);
      backdrop-filter: blur(10px);
      font-size: 0.875rem;
    }

    .logout-btn:hover {
      background: rgba(255, 0, 0, 0.3);
    }

    /* Section Title */
    .section-title {
      font-size: 2rem;
      font-weight: 900;
      margin-bottom: 24px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Category Cards */
    .categories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .category-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--border-radius);
      padding: 24px;
      cursor: pointer;
      transition: var(--transition);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .category-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary-gradient);
    }

    .category-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow);
      background: rgba(255, 255, 255, 0.15);
    }

    .category-content {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .category-icon {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 16px;
      min-width: 60px;
      text-align: center;
    }

    .category-icon i {
      font-size: 28px;
      color: var(--text-primary);
    }

    .category-info h3 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .category-info p {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .category-arrow {
      margin-left: auto;
      color: var(--text-secondary);
      transition: var(--transition);
    }

    .category-card:hover .category-arrow {
      color: var(--text-primary);
      transform: translateX(4px);
    }

    /* Profile Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: var(--card-bg);
      margin: 5% auto;
      padding: 0;
      border: 1px solid var(--card-border);
      width: 90%;
      max-width: 800px;
      border-radius: var(--border-radius);
      backdrop-filter: blur(20px);
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .close {
      color: var(--text-secondary);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
    }

    .close:hover {
      color: var(--text-primary);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      padding: 20px;
      border-bottom: 1px solid var(--card-border);
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-primary);
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .scores-table {
      width: 100%;
      border-collapse: collapse;
      padding: 20px;
    }

    .scores-table th,
    .scores-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--card-border);
    }

    .scores-table th {
      font-weight: 600;
      color: var(--text-secondary);
    }

    .scores-table td {
      color: var(--text-primary);
    }

    .score-percentage {
      font-weight: 600;
    }

    .score-category {
      text-transform: capitalize;
    }

    .no-scores {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    /* Quiz Loader */
    .loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
      text-align: center;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid var(--text-primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      color: #ff6b6b;
      margin-bottom: 16px;
    }

    .retry-btn {
      background: var(--primary-gradient);
      color: var(--text-primary);
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    .retry-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    /* Quiz Page */
    .quiz-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary-gradient);
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .question-counter {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .score-chip {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      padding: 8px 16px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
    }

    .score-chip i {
      color: #4caf50;
    }

    .question-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--border-radius);
      padding: 24px;
      margin-bottom: 24px;
      backdrop-filter: blur(10px);
      text-align: center;
    }

    .question-text {
      font-size: 1.25rem;
      font-weight: 700;
      line-height: 1.5;
    }

    /* Answer Buttons */
    .answers {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .answer-btn {
      background: var(--card-bg);
      border: 1.5px solid var(--card-border);
      color: var(--text-primary);
      padding: 16px 20px;
      border-radius: 16px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: var(--transition);
      backdrop-filter: blur(10px);
      text-align: left;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .answer-btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.15);
      border-color: var(--text-primary);
      transform: translateY(-2px);
    }

    .answer-btn:disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }

    .answer-correct {
      border-color: #4caf50 !important;
      background: rgba(76, 175, 80, 0.2) !important;
      color: #4caf50 !important;
    }

    .answer-correct i {
      color: #4caf50;
    }

    .answer-incorrect {
      border-color: #f44336 !important;
      background: rgba(244, 67, 54, 0.2) !important;
      color: #f44336 !important;
    }

    .answer-incorrect i {
      color: #f44336;
    }

    /* Score Page */
    .score-container {
      text-align: center;
      padding: 40px 20px;
    }

    .celebration-icon {
      font-size: 80px;
      color: var(--text-primary);
      margin-bottom: 24px;
    }

    .score-title {
      font-size: 2.5rem;
      font-weight: 900;
      margin-bottom: 16px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .category-score-msg {
      font-size: 1.25rem;
      color: var(--text-secondary);
      margin-bottom: 24px;
      font-weight: 500;
    }

    .score-subtitle {
      font-size: 1.25rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .score-value {
      font-size: 3rem;
      font-weight: 900;
      margin-bottom: 8px;
    }

    .percentage {
      font-size: 1.25rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .home-btn {
      background: var(--primary-gradient);
      color: var(--text-primary);
      border: none;
      padding: 16px 32px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1.125rem;
      font-weight: 600;
      margin-top: 40px;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .home-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .success-msg {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4caf50;
      color: #4caf50;
      padding: 12px;
      border-radius: 12px;
      margin-top: 16px;
      display: none;
    }

    .error-msg {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid #f44336;
      color: #f44336;
      padding: 12px;
      border-radius: 12px;
      margin-top: 16px;
      display: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .categories {
        grid-template-columns: 1fr;
      }

      .title {
        font-size: 1.5rem;
      }

      .header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }

      .quiz-header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }

      .question-card {
        padding: 20px;
      }

      .question-text {
        font-size: 1.125rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Hide sections */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Home Section -->
  <section id="home" class="container">
    <div class="header">
      <div class="header-left">
        <div class="logo">
          <i class="fas fa-brain"></i>
        </div>
        <div>
          <h1 class="title">Quiz Game</h1>
          <p class="subtitle">Challenge Yourself!</p>
        </div>
      </div>
      <div style="display: flex; align-items: center; gap: 10px;">
        <button id="profile-btn" class="profile-btn" onclick="toggleProfile()">
          <i class="fas fa-user"></i>
        </button>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>

    <h2 class="section-title">Explore Categories</h2>
    <div class="categories" id="categories"></div>
  </section>

  <!-- Profile Modal -->
  <div id="profile-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Your Profile & Stats</h2>
        <span class="close" onclick="toggleProfile()">&times;</span>
      </div>
      <div id="profile-loading" style="padding: 40px; text-align: center;">
        <div class="spinner" style="width: 40px; height: 40px; margin: 0 auto 16px;"></div>
        <p>Loading stats...</p>
      </div>
      <div id="profile-content" style="display: none;">
        <div class="stats-grid" id="stats-grid"></div>
        <table class="scores-table" id="scores-table">
          <thead>
            <tr>
              <th>Category</th>
              <th>Score</th>
              <th>Percentage</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="scores-body"></tbody>
        </table>
        <div id="no-scores" class="no-scores" style="display: none;">No quiz results yet. Take a quiz to see your progress!</div>
      </div>
    </div>
  </div>

  <!-- Quiz Loader Section -->
  <section id="loader" class="hidden container">
    <div class="loader">
      <div class="spinner"></div>
      <p>Loading Questions...</p>
    </div>
  </section>

  <!-- Error Section -->
  <section id="error" class="hidden container">
    <div class="loader">
      <i class="fas fa-exclamation-triangle" style="font-size: 80px; color: #ff6b6b; margin-bottom: 16px;"></i>
      <p class="error" id="error-message"></p>
      <button class="retry-btn" onclick="retryLoad()">
        <i class="fas fa-refresh"></i> Try Again
      </button>
    </div>
  </section>

  <!-- Quiz Section -->
  <section id="quiz" class="hidden">
    <div class="container quiz-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
      <div class="quiz-header">
        <div class="question-counter" id="question-counter">Question 1/10</div>
        <div class="score-chip" id="score-chip">
          <i class="fas fa-check-circle"></i>
          <span>0 Correct</span>
        </div>
      </div>
      <div class="question-card">
        <div class="question-text" id="question-text"></div>
      </div>
      <div class="answers" id="answers"></div>
    </div>
  </section>

  <!-- Score Section -->
  <section id="score" class="hidden">
    <div class="container score-container">
      <i class="fas fa-trophy celebration-icon"></i>
      <h1 class="score-title">Quiz Completed!</h1>
      <div class="category-score-msg" id="category-score-msg"></div>
      <p class="score-subtitle">Your Score</p>
      <div class="score-value" id="score-value">0 / 10</div>
      <div class="percentage" id="percentage">0%</div>
      <div id="save-status" class="success-msg"></div>
      <div id="save-error" class="error-msg"></div>
      <button class="home-btn" onclick="goHome()">
        <i class="fas fa-home"></i>
        Back to Home
      </button>
    </div>
  </section>

  <script>
    // Auth check
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'index.html';
    }

    // Configuration
    const OPENTDB_BASE = 'https://opentdb.com/api.php';
    const TOTAL_QUESTIONS = 10;
    const CATEGORIES = {
      'General Knowledge': 9,
      'Books': 10,
      'Film': 11,
      'Science & Nature': 17,
      'Computers': 18,
      'Mathematics': 19,
      'Sports': 21,
      'Geography': 22,
      'History': 23,
      'Art': 25
    };

    const ICON_MAP = {
      'Books': 'fa-book',
      'Film': 'fa-film',
      'Science & Nature': 'fa-flask',
      'Computers': 'fa-laptop',
      'Mathematics': 'fa-calculator',
      'Sports': 'fa-futbol',
      'Geography': 'fa-globe',
      'History': 'fa-clock',
      'Art': 'fa-palette',
      'General Knowledge': 'fa-lightbulb'
    };

    // State Variables
    let questions = [];
    let currentQuestionIndex = 0;
    let correctAnswersCount = 0;
    let isQuestionAnswered = false;
    let currentCategoryId = null;
    let currentCategoryName = '';
    let username = localStorage.getItem('username');

    // Utility Functions
    function showSection(sectionId) {
      document.querySelectorAll('section').forEach(section => section.classList.add('hidden'));
      document.getElementById(sectionId).classList.remove('hidden');
    }

    function cleanHtmlEntities(str) {
      const div = document.createElement('div');
      div.innerHTML = str;
      return div.innerText;
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function getScoresKey() {
      if (!username) {
        throw new Error('Username not set');
      }
      return `quizScores_${username}`;
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      localStorage.removeItem('gameUsername');
      localStorage.removeItem('fullName');
      window.location.href = 'index.html';
    }

    // Profile Functions
    function toggleProfile() {
      const modal = document.getElementById('profile-modal');
      if (modal.style.display === 'block') {
        modal.style.display = 'none';
      } else {
        document.querySelector('.modal-title').textContent = `Your Profile & Stats - ${username}`;
        modal.style.display = 'block';
        loadProfile();
      }
    }

    async function loadProfile() {
      if (!username) {
        document.getElementById('profile-loading').innerHTML = '<p style="color: #ff6b6b;">Please set a username to view profile.</p>';
        return;
      }

      try {
        document.getElementById('profile-loading').style.display = 'block';
        document.getElementById('profile-content').style.display = 'none';

        const scoresStr = localStorage.getItem(getScoresKey()) || '[]';
        const scores = JSON.parse(scoresStr);
        renderProfile(scores);
      } catch (error) {
        console.error('Error loading profile:', error);
        document.getElementById('profile-loading').innerHTML = `<p style="color: #ff6b6b;">Error: ${error.message}</p>`;
      } finally {
        document.getElementById('profile-loading').style.display = 'none';
      }
    }

    function renderProfile(scores) {
      const content = document.getElementById('profile-content');
      const noScoresEl = document.getElementById('no-scores');
      const tableBody = document.getElementById('scores-body');

      if (scores.length === 0) {
        noScoresEl.style.display = 'block';
        content.style.display = 'block';
        return;
      }

      noScoresEl.style.display = 'none';

      // Calculate advanced stats
      const totalScores = scores.length;
      const avgPercentage = Math.round(scores.reduce((sum, s) => sum + s.percentage, 0) / totalScores);
      const bestScore = Math.max(...scores.map(s => s.percentage));
      const bestCategory = scores.find(s => s.percentage === bestScore)?.category || 'N/A';
      const totalQuizzes = totalScores;
      const avgScore = Math.round(scores.reduce((sum, s) => sum + s.score, 0) / totalScores);

      // Render stats grid
      const statsGrid = document.getElementById('stats-grid');
      statsGrid.innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${totalQuizzes}</div>
          <div class="stat-label">Total Quizzes</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${avgScore}/${TOTAL_QUESTIONS}</div>
          <div class="stat-label">Avg Score</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${avgPercentage}%</div>
          <div class="stat-label">Avg Accuracy</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${bestScore}%</div>
          <div class="stat-label">Best: ${bestCategory}</div>
        </div>
      `;

      // Render scores table
      tableBody.innerHTML = '';
      scores.forEach(score => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="score-category">${score.category}</td>
          <td>${score.score} / ${score.total}</td>
          <td class="score-percentage">${score.percentage}%</td>
          <td>${formatDate(score.date)}</td>
        `;
        tableBody.appendChild(row);
      });

      content.style.display = 'block';
    }

    // Render Functions
    function renderCategories() {
      const container = document.getElementById('categories');
      if (!container) return;
      container.innerHTML = '';
      Object.entries(CATEGORIES).forEach(([name, id]) => {
        const card = document.createElement('div');
        card.className = 'category-card';
        card.innerHTML = `
          <div class="category-content">
            <div class="category-icon">
              <i class="fas ${ICON_MAP[name] || 'fa-lightbulb'}"></i>
            </div>
            <div class="category-info">
              <h3>${name}</h3>
              <p>Start Quiz</p>
            </div>
            <i class="fas fa-arrow-right category-arrow"></i>
          </div>
        `;
        card.addEventListener('click', () => startQuiz(name, id));
        container.appendChild(card);
      });
    }

    function renderQuestion() {
      if (currentQuestionIndex >= questions.length) {
        showScore();
        return;
      }

      const question = questions[currentQuestionIndex];
      document.getElementById('question-counter').textContent = `Question ${currentQuestionIndex + 1}/${TOTAL_QUESTIONS}`;
      document.getElementById('question-text').innerHTML = cleanHtmlEntities(question.question);
      document.getElementById('score-chip').innerHTML = `<i class="fas fa-check-circle"></i><span>${correctAnswersCount} Correct</span>`;

      const progress = ((currentQuestionIndex + 1) / TOTAL_QUESTIONS) * 100;
      document.getElementById('progress-fill').style.width = `${progress}%`;

      const answers = shuffleArray([...question.incorrect_answers, question.correct_answer]);
      const container = document.getElementById('answers');
      container.innerHTML = '';
      answers.forEach(answer => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';
        const iconClass = isQuestionAnswered ? (answer === question.correct_answer ? 'check' : 'times') : '';
        btn.innerHTML = `<i class="fas fa-${iconClass}"></i>${cleanHtmlEntities(answer)}`;
        btn.disabled = isQuestionAnswered;
        if (isQuestionAnswered) {
          if (answer === question.correct_answer) {
            btn.classList.add('answer-correct');
          } else {
            btn.classList.add('answer-incorrect');
          }
        }
        btn.addEventListener('click', () => checkAnswer(answer, question.correct_answer));
        container.appendChild(btn);
      });

      isQuestionAnswered = false;
    }

    function showScore() {
      const percentage = Math.round((correctAnswersCount / TOTAL_QUESTIONS) * 100);
      document.getElementById('score-value').textContent = `${correctAnswersCount} / ${TOTAL_QUESTIONS}`;
      document.getElementById('percentage').textContent = `${percentage}%`;

      // Display category-specific message
      const categoryMsg = document.getElementById('category-score-msg');
      if (currentCategoryName) {
        categoryMsg.textContent = `You got ${correctAnswersCount}/10 in ${currentCategoryName}`;
        categoryMsg.style.display = 'block';
      } else {
        categoryMsg.style.display = 'none';
      }

      // Save score
      if (username && currentCategoryName) {
        saveScore(currentCategoryName, correctAnswersCount, TOTAL_QUESTIONS);
      } else if (username) {
        saveScore('General Quiz', correctAnswersCount, TOTAL_QUESTIONS);
      } else {
        const errorEl = document.getElementById('save-error');
        errorEl.textContent = 'Please set a username to save scores';
        errorEl.style.display = 'block';
        setTimeout(() => errorEl.style.display = 'none', 5000);
      }

      showSection('score');
    }

    // API Functions
    async function loadQuestions() {
      try {
        showSection('loader');
        const params = new URLSearchParams({
          amount: TOTAL_QUESTIONS,
          category: currentCategoryId,
          type: 'multiple'
        });
        const response = await fetch(`${OPENTDB_BASE}?${params}`);
        if (!response.ok) throw new Error('Failed to fetch questions from Open Trivia DB');
        const data = await response.json();
        if (data.response_code !== 0) {
          throw new Error(data.response_code === 1 ? 'No questions available for this category' : 'API error');
        }
        
        questions = data.results.map(q => ({
          question: q.question,
          correct_answer: q.correct_answer,
          incorrect_answers: q.incorrect_answers
        }));
        currentQuestionIndex = 0;
        correctAnswersCount = 0;
        showSection('quiz');
        renderQuestion();
      } catch (error) {
        console.error('Error loading questions:', error);
        document.getElementById('error-message').textContent = error.message || 'Failed to load questions';
        showSection('error');
      }
    }

    async function saveScore(category, score, total) {
      try {
        const scoresStr = localStorage.getItem(getScoresKey()) || '[]';
        const scores = JSON.parse(scoresStr);
        const percentage = Math.round((score / total) * 100);
        scores.push({
          category,
          score,
          total,
          percentage,
          date: new Date().toISOString()
        });
        localStorage.setItem(getScoresKey(), JSON.stringify(scores));

        const statusEl = document.getElementById('save-status');
        const errorEl = document.getElementById('save-error');
        statusEl.textContent = 'Score saved successfully!';
        statusEl.style.display = 'block';
        errorEl.style.display = 'none';
        setTimeout(() => statusEl.style.display = 'none', 3000);
      } catch (error) {
        console.error('Error saving score:', error);
        const errorEl = document.getElementById('save-error');
        errorEl.textContent = 'Failed to save score';
        errorEl.style.display = 'block';
        setTimeout(() => errorEl.style.display = 'none', 5000);
      }
    }

    // Event Handlers
    function startQuiz(categoryName, categoryId) {
      currentCategoryName = categoryName;
      currentCategoryId = categoryId;
      loadQuestions();
    }

    function checkAnswer(selectedAnswer, correctAnswer) {
      if (isQuestionAnswered) return;
      isQuestionAnswered = true;

      // Update score if correct
      if (selectedAnswer === correctAnswer) {
        correctAnswersCount++;
      }

      // Re-render to show highlights
      renderQuestion();

      // Delay before next question
      setTimeout(() => {
        currentQuestionIndex++;
        renderQuestion();
      }, 1500);
    }

    function retryLoad() {
      if (currentCategoryId) {
        loadQuestions();
      }
    }

    function goHome() {
      showSection('home');
      // Reset quiz state
      questions = [];
      currentQuestionIndex = 0;
      correctAnswersCount = 0;
      currentCategoryId = null;
      currentCategoryName = '';
      document.getElementById('save-status').style.display = 'none';
      document.getElementById('save-error').style.display = 'none';
      document.getElementById('category-score-msg').style.display = 'none';
    }

    // Close modal on outside click
    window.onclick = function(event) {
      const modal = document.getElementById('profile-modal');
      if (event.target === modal) {
        toggleProfile();
      }
    }

    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
      if (!username) {
        const gameUsername = localStorage.getItem('gameUsername');
        if (gameUsername) {
          localStorage.setItem('username', gameUsername);
          username = gameUsername;
        } else {
          alert('Display name is required. Please log in again.');
          logout();
          return;
        }
      }
      renderCategories();
      document.getElementById('profile-btn').style.display = 'flex';
    });
  </script>
</body>

</html>
-->
